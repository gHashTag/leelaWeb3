{"version":3,"names":["_utils","require","defaultTransactionSource","exports","customTransactionSource","getBlankTransactionContext","name","op","tags","data","metadata","source","MARGIN_OF_ERROR_SECONDS","timeOriginMilliseconds","Date","now","adjustTransactionDuration","maxDurationMs","transaction","endTimestamp","diff","startTimestamp","isOutdatedTransaction","setStatus","setTag","getTimeOriginMilliseconds","instrumentChildSpanFinish","callback","spanRecorder","originalAdd","add","span","apply","originalSpanFinish","finish","isNearToNow","timestamp","Math","abs","timestampInSeconds"],"sources":["../../../src/js/tracing/utils.ts"],"sourcesContent":["import type { IdleTransaction, Span, Transaction } from '@sentry/core';\nimport type { TransactionContext, TransactionSource } from '@sentry/types';\nimport { timestampInSeconds } from '@sentry/utils';\n\nexport const defaultTransactionSource: TransactionSource = 'component';\nexport const customTransactionSource: TransactionSource = 'custom';\n\nexport const getBlankTransactionContext = (name: string): TransactionContext => {\n  return {\n    name: 'Route Change',\n    op: 'navigation',\n    tags: {\n      'routing.instrumentation': name,\n    },\n    data: {},\n    metadata: {\n      source: defaultTransactionSource,\n    },\n  };\n};\n\n/**\n * A margin of error of 50ms is allowed for the async native bridge call.\n * Anything larger would reduce the accuracy of our frames measurements.\n */\nexport const MARGIN_OF_ERROR_SECONDS = 0.05;\n\nconst timeOriginMilliseconds = Date.now();\n\n/**\n *\n */\nexport function adjustTransactionDuration(\n  maxDurationMs: number,\n  transaction: IdleTransaction,\n  endTimestamp: number,\n): void {\n  const diff = endTimestamp - transaction.startTimestamp;\n  const isOutdatedTransaction = endTimestamp && (diff > maxDurationMs || diff < 0);\n  if (isOutdatedTransaction) {\n    transaction.setStatus('deadline_exceeded');\n    transaction.setTag('maxTransactionDurationExceeded', 'true');\n  }\n}\n\n/**\n * Returns the timestamp where the JS global scope was initialized.\n */\nexport function getTimeOriginMilliseconds(): number {\n  return timeOriginMilliseconds;\n}\n\n/**\n * Calls the callback every time a child span of the transaction is finished.\n */\nexport function instrumentChildSpanFinish(\n  transaction: Transaction,\n  callback: (span: Span, endTimestamp?: number) => void,\n): void {\n  if (transaction.spanRecorder) {\n    // eslint-disable-next-line @typescript-eslint/unbound-method\n    const originalAdd = transaction.spanRecorder.add;\n\n    transaction.spanRecorder.add = (span: Span): void => {\n      originalAdd.apply(transaction.spanRecorder, [span]);\n\n      // eslint-disable-next-line @typescript-eslint/unbound-method\n      const originalSpanFinish = span.finish;\n\n      span.finish = (endTimestamp?: number) => {\n        originalSpanFinish.apply(span, [endTimestamp]);\n\n        callback(span, endTimestamp);\n      };\n    };\n  }\n}\n\n/**\n * Determines if the timestamp is now or within the specified margin of error from now.\n */\nexport function isNearToNow(timestamp: number): boolean {\n  return Math.abs(timestampInSeconds() - timestamp) <= MARGIN_OF_ERROR_SECONDS;\n}\n"],"mappings":";;;;;;;;;AAEA,IAAAA,MAAA,GAAAC,OAAA;AAEO,IAAMC,wBAAwB,GAAsB,WAAW;AAACC,OAAA,CAAAD,wBAAA,GAAAA,wBAAA;AAChE,IAAME,uBAAuB,GAAsB,QAAQ;AAACD,OAAA,CAAAC,uBAAA,GAAAA,uBAAA;AAE5D,IAAMC,0BAA0B,GAAG,SAA7BA,0BAA0BA,CAAIC,IAAY,EAAwB;EAC7E,OAAO;IACLA,IAAI,EAAE,cAAc;IACpBC,EAAE,EAAE,YAAY;IAChBC,IAAI,EAAE;MACJ,yBAAyB,EAAEF;KAC5B;IACDG,IAAI,EAAE,EAAE;IACRC,QAAQ,EAAE;MACRC,MAAM,EAAET;;GAEX;AACH,CAAC;AAACC,OAAA,CAAAE,0BAAA,GAAAA,0BAAA;AAMK,IAAMO,uBAAuB,GAAG,IAAI;AAACT,OAAA,CAAAS,uBAAA,GAAAA,uBAAA;AAE5C,IAAMC,sBAAsB,GAAGC,IAAI,CAACC,GAAG,EAAE;AAKnC,SAAUC,yBAAyBA,CACvCC,aAAqB,EACrBC,WAA4B,EAC5BC,YAAoB;EAEpB,IAAMC,IAAI,GAAGD,YAAY,GAAGD,WAAW,CAACG,cAAc;EACtD,IAAMC,qBAAqB,GAAGH,YAAY,KAAKC,IAAI,GAAGH,aAAa,IAAIG,IAAI,GAAG,CAAC,CAAC;EAChF,IAAIE,qBAAqB,EAAE;IACzBJ,WAAW,CAACK,SAAS,CAAC,mBAAmB,CAAC;IAC1CL,WAAW,CAACM,MAAM,CAAC,gCAAgC,EAAE,MAAM,CAAC;;AAEhE;AAKM,SAAUC,yBAAyBA,CAAA;EACvC,OAAOZ,sBAAsB;AAC/B;AAKM,SAAUa,yBAAyBA,CACvCR,WAAwB,EACxBS,QAAqD;EAErD,IAAIT,WAAW,CAACU,YAAY,EAAE;IAE5B,IAAMC,WAAW,GAAGX,WAAW,CAACU,YAAY,CAACE,GAAG;IAEhDZ,WAAW,CAACU,YAAY,CAACE,GAAG,GAAG,UAACC,IAAU,EAAU;MAClDF,WAAW,CAACG,KAAK,CAACd,WAAW,CAACU,YAAY,EAAE,CAACG,IAAI,CAAC,CAAC;MAGnD,IAAME,kBAAkB,GAAGF,IAAI,CAACG,MAAM;MAEtCH,IAAI,CAACG,MAAM,GAAG,UAACf,YAAqB,EAAI;QACtCc,kBAAkB,CAACD,KAAK,CAACD,IAAI,EAAE,CAACZ,YAAY,CAAC,CAAC;QAE9CQ,QAAQ,CAACI,IAAI,EAAEZ,YAAY,CAAC;MAC9B,CAAC;IACH,CAAC;;AAEL;AAKM,SAAUgB,WAAWA,CAACC,SAAiB;EAC3C,OAAOC,IAAI,CAACC,GAAG,CAAC,IAAAC,yBAAkB,GAAE,GAAGH,SAAS,CAAC,IAAIxB,uBAAuB;AAC9E"}