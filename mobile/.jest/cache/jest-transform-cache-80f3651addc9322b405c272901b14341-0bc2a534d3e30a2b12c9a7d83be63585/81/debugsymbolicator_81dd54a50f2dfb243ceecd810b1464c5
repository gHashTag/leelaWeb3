86ebbf5210a9345cc4e5d376eb7af747
var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.DebugSymbolicator = void 0;
var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));
var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));
var _tslib = require("tslib");
var _core = require("@sentry/core");
var _utils = require("@sentry/utils");
var INTERNAL_CALLSITES_REGEX = new RegExp(['ReactNativeRenderer-dev\\.js$', 'MessageQueue\\.js$'].join('|'));
var DebugSymbolicator = function () {
  function DebugSymbolicator() {
    (0, _classCallCheck2.default)(this, DebugSymbolicator);
    this.name = DebugSymbolicator.id;
  }
  (0, _createClass2.default)(DebugSymbolicator, [{
    key: "setupOnce",
    value: function setupOnce() {
      var _this = this;
      (0, _core.addGlobalEventProcessor)(function (event, hint) {
        return (0, _tslib.__awaiter)(_this, void 0, void 0, function* () {
          var self = (0, _core.getCurrentHub)().getIntegration(DebugSymbolicator);
          if (!self || hint === undefined || hint.originalException === undefined) {
            return event;
          }
          var reactError = hint.originalException;
          var parseErrorStack = require('react-native/Libraries/Core/Devtools/parseErrorStack');
          var stack;
          try {
            stack = parseErrorStack(reactError);
          } catch (e) {
            stack = parseErrorStack(reactError.stack);
          }
          yield self._symbolicate(event, stack);
          event.platform = 'node';
          return event;
        });
      });
    }
  }, {
    key: "_symbolicate",
    value: function _symbolicate(event, stack) {
      return (0, _tslib.__awaiter)(this, void 0, void 0, function* () {
        try {
          var symbolicateStackTrace = require('react-native/Libraries/Core/Devtools/symbolicateStackTrace');
          var prettyStack = yield symbolicateStackTrace(stack);
          if (prettyStack) {
            var newStack = prettyStack;
            if (prettyStack.stack) {
              newStack = prettyStack.stack;
            }
            var stackWithoutInternalCallsites = newStack.filter(function (frame) {
              return frame.file && frame.file.match(INTERNAL_CALLSITES_REGEX) === null;
            });
            var symbolicatedFrames = yield this._convertReactNativeFramesToSentryFrames(stackWithoutInternalCallsites);
            this._replaceFramesInEvent(event, symbolicatedFrames);
          } else {
            _utils.logger.error('The stack is null');
          }
        } catch (error) {
          if (error instanceof Error) {
            _utils.logger.warn(`Unable to symbolicate stack trace: ${error.message}`);
          }
        }
      });
    }
  }, {
    key: "_convertReactNativeFramesToSentryFrames",
    value: function _convertReactNativeFramesToSentryFrames(frames) {
      return (0, _tslib.__awaiter)(this, void 0, void 0, function* () {
        var _this2 = this;
        var getDevServer;
        try {
          getDevServer = require('react-native/Libraries/Core/Devtools/getDevServer');
        } catch (_oO) {}
        return Promise.all(frames.map(function (frame) {
          return (0, _tslib.__awaiter)(_this2, void 0, void 0, function* () {
            var inApp = !!frame.column && !!frame.lineNumber;
            inApp = inApp && frame.file !== undefined && !frame.file.includes('node_modules') && !frame.file.includes('native code');
            var newFrame = {
              colno: frame.column,
              filename: frame.file,
              function: frame.methodName,
              in_app: inApp,
              lineno: inApp ? frame.lineNumber : undefined,
              platform: inApp ? 'javascript' : 'node'
            };
            if (newFrame.function) {
              var addressAtPos = newFrame.function.indexOf('(address at');
              if (addressAtPos >= 0) {
                newFrame.function = newFrame.function.substr(0, addressAtPos).trim();
              }
            }
            if (inApp) {
              yield this._addSourceContext(newFrame, getDevServer);
            }
            return newFrame;
          });
        }));
      });
    }
  }, {
    key: "_replaceFramesInEvent",
    value: function _replaceFramesInEvent(event, frames) {
      if (event.exception && event.exception.values && event.exception.values[0] && event.exception.values[0].stacktrace) {
        event.exception.values[0].stacktrace.frames = frames.reverse();
      }
    }
  }, {
    key: "_addSourceContext",
    value: function _addSourceContext(frame, getDevServer) {
      var _a, _b;
      return (0, _tslib.__awaiter)(this, void 0, void 0, function* () {
        var response;
        var segments = (_b = (_a = frame.filename) === null || _a === void 0 ? void 0 : _a.split('/')) !== null && _b !== void 0 ? _b : [];
        if (getDevServer) {
          for (var idx in segments) {
            if (Object.prototype.hasOwnProperty.call(segments, idx)) {
              response = yield fetch(`${getDevServer().url}${segments.slice(-idx).join('/')}`, {
                method: 'GET'
              });
              if (response.ok) {
                break;
              }
            }
          }
        }
        if (response && response.ok) {
          var content = yield response.text();
          var lines = content.split('\n');
          (0, _utils.addContextToFrame)(lines, frame);
        }
      });
    }
  }]);
  return DebugSymbolicator;
}();
exports.DebugSymbolicator = DebugSymbolicator;
DebugSymbolicator.id = 'DebugSymbolicator';
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfY29yZSIsInJlcXVpcmUiLCJfdXRpbHMiLCJJTlRFUk5BTF9DQUxMU0lURVNfUkVHRVgiLCJSZWdFeHAiLCJqb2luIiwiRGVidWdTeW1ib2xpY2F0b3IiLCJfY2xhc3NDYWxsQ2hlY2syIiwiZGVmYXVsdCIsIm5hbWUiLCJpZCIsIl9jcmVhdGVDbGFzczIiLCJrZXkiLCJ2YWx1ZSIsInNldHVwT25jZSIsIl90aGlzIiwiYWRkR2xvYmFsRXZlbnRQcm9jZXNzb3IiLCJldmVudCIsImhpbnQiLCJfX2F3YWl0ZXIiLCJzZWxmIiwiZ2V0Q3VycmVudEh1YiIsImdldEludGVncmF0aW9uIiwidW5kZWZpbmVkIiwib3JpZ2luYWxFeGNlcHRpb24iLCJyZWFjdEVycm9yIiwicGFyc2VFcnJvclN0YWNrIiwic3RhY2siLCJlIiwiX3N5bWJvbGljYXRlIiwicGxhdGZvcm0iLCJzeW1ib2xpY2F0ZVN0YWNrVHJhY2UiLCJwcmV0dHlTdGFjayIsIm5ld1N0YWNrIiwic3RhY2tXaXRob3V0SW50ZXJuYWxDYWxsc2l0ZXMiLCJmaWx0ZXIiLCJmcmFtZSIsImZpbGUiLCJtYXRjaCIsInN5bWJvbGljYXRlZEZyYW1lcyIsIl9jb252ZXJ0UmVhY3ROYXRpdmVGcmFtZXNUb1NlbnRyeUZyYW1lcyIsIl9yZXBsYWNlRnJhbWVzSW5FdmVudCIsImxvZ2dlciIsImVycm9yIiwiRXJyb3IiLCJ3YXJuIiwibWVzc2FnZSIsImZyYW1lcyIsImdldERldlNlcnZlciIsIl9vTyIsIlByb21pc2UiLCJhbGwiLCJtYXAiLCJfdGhpczIiLCJpbkFwcCIsImNvbHVtbiIsImxpbmVOdW1iZXIiLCJpbmNsdWRlcyIsIm5ld0ZyYW1lIiwiY29sbm8iLCJmaWxlbmFtZSIsImZ1bmN0aW9uIiwibWV0aG9kTmFtZSIsImluX2FwcCIsImxpbmVubyIsImFkZHJlc3NBdFBvcyIsImluZGV4T2YiLCJzdWJzdHIiLCJ0cmltIiwiX2FkZFNvdXJjZUNvbnRleHQiLCJleGNlcHRpb24iLCJ2YWx1ZXMiLCJzdGFja3RyYWNlIiwicmV2ZXJzZSIsInJlc3BvbnNlIiwic2VnbWVudHMiLCJfYiIsIl9hIiwic3BsaXQiLCJpZHgiLCJPYmplY3QiLCJwcm90b3R5cGUiLCJoYXNPd25Qcm9wZXJ0eSIsImNhbGwiLCJmZXRjaCIsInVybCIsInNsaWNlIiwibWV0aG9kIiwib2siLCJjb250ZW50IiwidGV4dCIsImxpbmVzIiwiYWRkQ29udGV4dFRvRnJhbWUiLCJleHBvcnRzIl0sInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2pzL2ludGVncmF0aW9ucy9kZWJ1Z3N5bWJvbGljYXRvci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBhZGRHbG9iYWxFdmVudFByb2Nlc3NvciwgZ2V0Q3VycmVudEh1YiB9IGZyb20gJ0BzZW50cnkvY29yZSc7XG5pbXBvcnQgdHlwZSB7IEV2ZW50LCBFdmVudEhpbnQsIEludGVncmF0aW9uLCBTdGFja0ZyYW1lIH0gZnJvbSAnQHNlbnRyeS90eXBlcyc7XG5pbXBvcnQgeyBhZGRDb250ZXh0VG9GcmFtZSwgbG9nZ2VyIH0gZnJvbSAnQHNlbnRyeS91dGlscyc7XG5cbmNvbnN0IElOVEVSTkFMX0NBTExTSVRFU19SRUdFWCA9IG5ldyBSZWdFeHAoWydSZWFjdE5hdGl2ZVJlbmRlcmVyLWRldlxcXFwuanMkJywgJ01lc3NhZ2VRdWV1ZVxcXFwuanMkJ10uam9pbignfCcpKTtcblxuaW50ZXJmYWNlIEdldERldlNlcnZlciB7XG4gICgpOiB7IHVybDogc3RyaW5nIH07XG59XG5cbi8qKlxuICogUmVhY3QgTmF0aXZlIFN0YWNrIEZyYW1lXG4gKi9cbmludGVyZmFjZSBSZWFjdE5hdGl2ZUZyYW1lIHtcbiAgLy8gYXJndW1lbnRzOiBbXVxuICBjb2x1bW46IG51bWJlcjtcbiAgZmlsZTogc3RyaW5nO1xuICBsaW5lTnVtYmVyOiBudW1iZXI7XG4gIG1ldGhvZE5hbWU6IHN0cmluZztcbn1cblxuLyoqXG4gKiBSZWFjdCBOYXRpdmUgRXJyb3JcbiAqL1xuZXhwb3J0IHR5cGUgUmVhY3ROYXRpdmVFcnJvciA9IEVycm9yICYge1xuICBmcmFtZXNUb1BvcD86IG51bWJlcjtcbiAganNFbmdpbmU/OiBzdHJpbmc7XG4gIHByZXZlbnRTeW1ib2xpY2F0aW9uPzogYm9vbGVhbjtcbiAgY29tcG9uZW50U3RhY2s/OiBzdHJpbmc7XG59O1xuXG4vKiogVHJpZXMgdG8gc3ltYm9saWNhdGUgdGhlIEpTIHN0YWNrIHRyYWNlIG9uIHRoZSBkZXZpY2UuICovXG5leHBvcnQgY2xhc3MgRGVidWdTeW1ib2xpY2F0b3IgaW1wbGVtZW50cyBJbnRlZ3JhdGlvbiB7XG4gIC8qKlxuICAgKiBAaW5oZXJpdERvY1xuICAgKi9cbiAgcHVibGljIHN0YXRpYyBpZDogc3RyaW5nID0gJ0RlYnVnU3ltYm9saWNhdG9yJztcbiAgLyoqXG4gICAqIEBpbmhlcml0RG9jXG4gICAqL1xuICBwdWJsaWMgbmFtZTogc3RyaW5nID0gRGVidWdTeW1ib2xpY2F0b3IuaWQ7XG5cbiAgLyoqXG4gICAqIEBpbmhlcml0RG9jXG4gICAqL1xuICBwdWJsaWMgc2V0dXBPbmNlKCk6IHZvaWQge1xuICAgIGFkZEdsb2JhbEV2ZW50UHJvY2Vzc29yKGFzeW5jIChldmVudDogRXZlbnQsIGhpbnQ/OiBFdmVudEhpbnQpID0+IHtcbiAgICAgIGNvbnN0IHNlbGYgPSBnZXRDdXJyZW50SHViKCkuZ2V0SW50ZWdyYXRpb24oRGVidWdTeW1ib2xpY2F0b3IpO1xuXG4gICAgICBpZiAoIXNlbGYgfHwgaGludCA9PT0gdW5kZWZpbmVkIHx8IGhpbnQub3JpZ2luYWxFeGNlcHRpb24gPT09IHVuZGVmaW5lZCkge1xuICAgICAgICByZXR1cm4gZXZlbnQ7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHJlYWN0RXJyb3IgPSBoaW50Lm9yaWdpbmFsRXhjZXB0aW9uIGFzIFJlYWN0TmF0aXZlRXJyb3I7XG5cbiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tdmFyLXJlcXVpcmVzXG4gICAgICBjb25zdCBwYXJzZUVycm9yU3RhY2sgPSByZXF1aXJlKCdyZWFjdC1uYXRpdmUvTGlicmFyaWVzL0NvcmUvRGV2dG9vbHMvcGFyc2VFcnJvclN0YWNrJyk7XG5cbiAgICAgIGxldCBzdGFjaztcbiAgICAgIHRyeSB7XG4gICAgICAgIHN0YWNrID0gcGFyc2VFcnJvclN0YWNrKHJlYWN0RXJyb3IpO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAvLyBJbiBSTiAwLjY0IGBwYXJzZUVycm9yU3RhY2tgIG5vdyBvbmx5IHRha2VzIGEgc3RyaW5nXG4gICAgICAgIHN0YWNrID0gcGFyc2VFcnJvclN0YWNrKHJlYWN0RXJyb3Iuc3RhY2spO1xuICAgICAgfVxuXG4gICAgICBhd2FpdCBzZWxmLl9zeW1ib2xpY2F0ZShldmVudCwgc3RhY2spO1xuXG4gICAgICBldmVudC5wbGF0Zm9ybSA9ICdub2RlJzsgLy8gU2V0dGluZyBwbGF0Zm9ybSBub2RlIG1ha2VzIHN1cmUgd2UgZG8gbm90IHNob3cgc291cmNlIG1hcHMgZXJyb3JzXG5cbiAgICAgIHJldHVybiBldmVudDtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTeW1ib2xpY2F0ZXMgdGhlIHN0YWNrIG9uIHRoZSBkZXZpY2UgdGFsa2luZyB0byBsb2NhbCBkZXYgc2VydmVyLlxuICAgKiBNdXRhdGVzIHRoZSBwYXNzZWQgZXZlbnQuXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIF9zeW1ib2xpY2F0ZShldmVudDogRXZlbnQsIHN0YWNrOiBzdHJpbmcgfCB1bmRlZmluZWQpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0cnkge1xuICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby12YXItcmVxdWlyZXNcbiAgICAgIGNvbnN0IHN5bWJvbGljYXRlU3RhY2tUcmFjZSA9IHJlcXVpcmUoJ3JlYWN0LW5hdGl2ZS9MaWJyYXJpZXMvQ29yZS9EZXZ0b29scy9zeW1ib2xpY2F0ZVN0YWNrVHJhY2UnKTtcbiAgICAgIGNvbnN0IHByZXR0eVN0YWNrID0gYXdhaXQgc3ltYm9saWNhdGVTdGFja1RyYWNlKHN0YWNrKTtcblxuICAgICAgaWYgKHByZXR0eVN0YWNrKSB7XG4gICAgICAgIGxldCBuZXdTdGFjayA9IHByZXR0eVN0YWNrO1xuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLXVuc2FmZS1tZW1iZXItYWNjZXNzXG4gICAgICAgIGlmIChwcmV0dHlTdGFjay5zdGFjaykge1xuICAgICAgICAgIC8vIFRoaXMgaGFzIGJlZW4gY2hhbmdlZCBpbiBhbiByZWFjdC1uYXRpdmUgdmVyc2lvbiBzbyBzdGFjayBpcyBjb250YWluZWQgaW4gaGVyZVxuICAgICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tdW5zYWZlLW1lbWJlci1hY2Nlc3NcbiAgICAgICAgICBuZXdTdGFjayA9IHByZXR0eVN0YWNrLnN0YWNrO1xuICAgICAgICB9XG4gICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tdW5zYWZlLW1lbWJlci1hY2Nlc3NcbiAgICAgICAgY29uc3Qgc3RhY2tXaXRob3V0SW50ZXJuYWxDYWxsc2l0ZXMgPSBuZXdTdGFjay5maWx0ZXIoXG4gICAgICAgICAgKGZyYW1lOiB7IGZpbGU/OiBzdHJpbmcgfSkgPT5cbiAgICAgICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tdW5zYWZlLW1lbWJlci1hY2Nlc3NcbiAgICAgICAgICAgIGZyYW1lLmZpbGUgJiYgZnJhbWUuZmlsZS5tYXRjaChJTlRFUk5BTF9DQUxMU0lURVNfUkVHRVgpID09PSBudWxsLFxuICAgICAgICApO1xuXG4gICAgICAgIGNvbnN0IHN5bWJvbGljYXRlZEZyYW1lcyA9IGF3YWl0IHRoaXMuX2NvbnZlcnRSZWFjdE5hdGl2ZUZyYW1lc1RvU2VudHJ5RnJhbWVzKHN0YWNrV2l0aG91dEludGVybmFsQ2FsbHNpdGVzKTtcbiAgICAgICAgdGhpcy5fcmVwbGFjZUZyYW1lc0luRXZlbnQoZXZlbnQsIHN5bWJvbGljYXRlZEZyYW1lcyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBsb2dnZXIuZXJyb3IoJ1RoZSBzdGFjayBpcyBudWxsJyk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIEVycm9yKSB7XG4gICAgICAgIGxvZ2dlci53YXJuKGBVbmFibGUgdG8gc3ltYm9saWNhdGUgc3RhY2sgdHJhY2U6ICR7ZXJyb3IubWVzc2FnZX1gKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQ29udmVydHMgUmVhY3ROYXRpdmVGcmFtZXMgdG8gZnJhbWVzIGluIHRoZSBTZW50cnkgZm9ybWF0XG4gICAqIEBwYXJhbSBmcmFtZXMgUmVhY3ROYXRpdmVGcmFtZVtdXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIF9jb252ZXJ0UmVhY3ROYXRpdmVGcmFtZXNUb1NlbnRyeUZyYW1lcyhmcmFtZXM6IFJlYWN0TmF0aXZlRnJhbWVbXSk6IFByb21pc2U8U3RhY2tGcmFtZVtdPiB7XG4gICAgbGV0IGdldERldlNlcnZlcjogR2V0RGV2U2VydmVyO1xuICAgIHRyeSB7XG4gICAgICBnZXREZXZTZXJ2ZXIgPSByZXF1aXJlKCdyZWFjdC1uYXRpdmUvTGlicmFyaWVzL0NvcmUvRGV2dG9vbHMvZ2V0RGV2U2VydmVyJyk7XG4gICAgfSBjYXRjaCAoX29PKSB7XG4gICAgICAvLyBXZSBjYW4ndCBsb2FkIGRldnNlcnZlciBVUkxcbiAgICB9XG4gICAgLy8gQmVsb3cgeW91IHdpbGwgZmluZCBsaW5lcyBtYXJrZWQgd2l0aCA6SEFDSyB0byBwcmV2ZW50IHNob3dpbmcgZXJyb3JzIGluIHRoZSBzZW50cnkgdWlcbiAgICAvLyBCdXQgc2luY2UgdGhpcyBpcyBhIGRlYnVnIG9ubHkgZmVhdHVyZTogVGhpcyBpcyBGaW5lIChUTSlcbiAgICByZXR1cm4gUHJvbWlzZS5hbGwoXG4gICAgICBmcmFtZXMubWFwKGFzeW5jIChmcmFtZTogUmVhY3ROYXRpdmVGcmFtZSk6IFByb21pc2U8U3RhY2tGcmFtZT4gPT4ge1xuICAgICAgICBsZXQgaW5BcHAgPSAhIWZyYW1lLmNvbHVtbiAmJiAhIWZyYW1lLmxpbmVOdW1iZXI7XG4gICAgICAgIGluQXBwID1cbiAgICAgICAgICBpbkFwcCAmJlxuICAgICAgICAgIGZyYW1lLmZpbGUgIT09IHVuZGVmaW5lZCAmJlxuICAgICAgICAgICFmcmFtZS5maWxlLmluY2x1ZGVzKCdub2RlX21vZHVsZXMnKSAmJlxuICAgICAgICAgICFmcmFtZS5maWxlLmluY2x1ZGVzKCduYXRpdmUgY29kZScpO1xuXG4gICAgICAgIGNvbnN0IG5ld0ZyYW1lOiBTdGFja0ZyYW1lID0ge1xuICAgICAgICAgIGNvbG5vOiBmcmFtZS5jb2x1bW4sXG4gICAgICAgICAgZmlsZW5hbWU6IGZyYW1lLmZpbGUsXG4gICAgICAgICAgZnVuY3Rpb246IGZyYW1lLm1ldGhvZE5hbWUsXG4gICAgICAgICAgaW5fYXBwOiBpbkFwcCxcbiAgICAgICAgICBsaW5lbm86IGluQXBwID8gZnJhbWUubGluZU51bWJlciA6IHVuZGVmaW5lZCwgLy8gOkhBQ0tcbiAgICAgICAgICBwbGF0Zm9ybTogaW5BcHAgPyAnamF2YXNjcmlwdCcgOiAnbm9kZScsIC8vIDpIQUNLXG4gICAgICAgIH07XG5cbiAgICAgICAgLy8gVGhlIHVwc3RyZWFtIGByZWFjdC1uYXRpdmVAMC42MWAgZGVsZWdhdGVzIHBhcnNpbmcgb2Ygc3RhY2tzIHRvIGBzdGFja3RyYWNlLXBhcnNlcmAsIHdoaWNoIGlzIGJ1Z2d5IGFuZFxuICAgICAgICAvLyBsZWF2ZXMgYSB0cmFpbGluZyBgKGFkZHJlc3MgYXRgIGluIHRoZSBmdW5jdGlvbiBuYW1lLlxuICAgICAgICAvLyBgcmVhY3QtbmF0aXZlQDAuNjJgIHNlZW1zIHRvIGhhdmUgY3VzdG9tIGxvZ2ljIHRvIHBhcnNlIGhlcm1lcyBmcmFtZXMgc3BlY2lhbGx5LlxuICAgICAgICAvLyBBbnl3YXksIGFsbCB3ZSBkbyBoZXJlIGlzIHRocm93IGF3YXkgdGhlIGJvZ3VzIHN1ZmZpeC5cbiAgICAgICAgaWYgKG5ld0ZyYW1lLmZ1bmN0aW9uKSB7XG4gICAgICAgICAgY29uc3QgYWRkcmVzc0F0UG9zID0gbmV3RnJhbWUuZnVuY3Rpb24uaW5kZXhPZignKGFkZHJlc3MgYXQnKTtcbiAgICAgICAgICBpZiAoYWRkcmVzc0F0UG9zID49IDApIHtcbiAgICAgICAgICAgIG5ld0ZyYW1lLmZ1bmN0aW9uID0gbmV3RnJhbWUuZnVuY3Rpb24uc3Vic3RyKDAsIGFkZHJlc3NBdFBvcykudHJpbSgpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChpbkFwcCkge1xuICAgICAgICAgIGF3YWl0IHRoaXMuX2FkZFNvdXJjZUNvbnRleHQobmV3RnJhbWUsIGdldERldlNlcnZlcik7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gbmV3RnJhbWU7XG4gICAgICB9KSxcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlcGxhY2VzIHRoZSBmcmFtZXMgaW4gdGhlIGV4Y2VwdGlvbiBvZiBhIGVycm9yLlxuICAgKiBAcGFyYW0gZXZlbnQgRXZlbnRcbiAgICogQHBhcmFtIGZyYW1lcyBTdGFja0ZyYW1lW11cbiAgICovXG4gIHByaXZhdGUgX3JlcGxhY2VGcmFtZXNJbkV2ZW50KGV2ZW50OiBFdmVudCwgZnJhbWVzOiBTdGFja0ZyYW1lW10pOiB2b2lkIHtcbiAgICBpZiAoXG4gICAgICBldmVudC5leGNlcHRpb24gJiZcbiAgICAgIGV2ZW50LmV4Y2VwdGlvbi52YWx1ZXMgJiZcbiAgICAgIGV2ZW50LmV4Y2VwdGlvbi52YWx1ZXNbMF0gJiZcbiAgICAgIGV2ZW50LmV4Y2VwdGlvbi52YWx1ZXNbMF0uc3RhY2t0cmFjZVxuICAgICkge1xuICAgICAgZXZlbnQuZXhjZXB0aW9uLnZhbHVlc1swXS5zdGFja3RyYWNlLmZyYW1lcyA9IGZyYW1lcy5yZXZlcnNlKCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFRoaXMgdHJpZXMgdG8gYWRkIHNvdXJjZSBjb250ZXh0IGZvciBpbl9hcHAgRnJhbWVzXG4gICAqXG4gICAqIEBwYXJhbSBmcmFtZSBTdGFja0ZyYW1lXG4gICAqIEBwYXJhbSBnZXREZXZTZXJ2ZXIgZnVuY3Rpb24gZnJvbSBSTiB0byBnZXQgRGV2U2VydmVyIFVSTFxuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBfYWRkU291cmNlQ29udGV4dChmcmFtZTogU3RhY2tGcmFtZSwgZ2V0RGV2U2VydmVyPzogR2V0RGV2U2VydmVyKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgbGV0IHJlc3BvbnNlO1xuXG4gICAgY29uc3Qgc2VnbWVudHMgPSBmcmFtZS5maWxlbmFtZT8uc3BsaXQoJy8nKSA/PyBbXTtcblxuICAgIGlmIChnZXREZXZTZXJ2ZXIpIHtcbiAgICAgIGZvciAoY29uc3QgaWR4IGluIHNlZ21lbnRzKSB7XG4gICAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoc2VnbWVudHMsIGlkeCkpIHtcbiAgICAgICAgICByZXNwb25zZSA9IGF3YWl0IGZldGNoKGAke2dldERldlNlcnZlcigpLnVybH0ke3NlZ21lbnRzLnNsaWNlKC1pZHgpLmpvaW4oJy8nKX1gLCB7XG4gICAgICAgICAgICBtZXRob2Q6ICdHRVQnLFxuICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgaWYgKHJlc3BvbnNlLm9rKSB7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAocmVzcG9uc2UgJiYgcmVzcG9uc2Uub2spIHtcbiAgICAgIGNvbnN0IGNvbnRlbnQgPSBhd2FpdCByZXNwb25zZS50ZXh0KCk7XG4gICAgICBjb25zdCBsaW5lcyA9IGNvbnRlbnQuc3BsaXQoJ1xcbicpO1xuXG4gICAgICBhZGRDb250ZXh0VG9GcmFtZShsaW5lcywgZnJhbWUpO1xuICAgIH1cbiAgfVxufVxuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7OztBQUFBLElBQUFBLEtBQUEsR0FBQUMsT0FBQTtBQUVBLElBQUFDLE1BQUEsR0FBQUQsT0FBQTtBQUVBLElBQU1FLHdCQUF3QixHQUFHLElBQUlDLE1BQU0sQ0FBQyxDQUFDLCtCQUErQixFQUFFLG9CQUFvQixDQUFDLENBQUNDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUFDLElBNEJsR0MsaUJBQWlCO0VBQTlCLFNBQUFBLGtCQUFBO0lBQUEsSUFBQUMsZ0JBQUEsQ0FBQUMsT0FBQSxRQUFBRixpQkFBQTtJQVFTLEtBQUFHLElBQUksR0FBV0gsaUJBQWlCLENBQUNJLEVBQUU7RUEwSzVDO0VBQUMsSUFBQUMsYUFBQSxDQUFBSCxPQUFBLEVBQUFGLGlCQUFBO0lBQUFNLEdBQUE7SUFBQUMsS0FBQSxFQXJLUSxTQUFBQyxVQUFBLEVBQVM7TUFBQSxJQUFBQyxLQUFBO01BQ2QsSUFBQUMsNkJBQXVCLEVBQUMsVUFBT0MsS0FBWSxFQUFFQyxJQUFnQjtRQUFBLE9BQUksSUFBQUMsZ0JBQUEsRUFBQUosS0FBQTtVQUMvRCxJQUFNSyxJQUFJLEdBQUcsSUFBQUMsbUJBQWEsR0FBRSxDQUFDQyxjQUFjLENBQUNoQixpQkFBaUIsQ0FBQztVQUU5RCxJQUFJLENBQUNjLElBQUksSUFBSUYsSUFBSSxLQUFLSyxTQUFTLElBQUlMLElBQUksQ0FBQ00saUJBQWlCLEtBQUtELFNBQVMsRUFBRTtZQUN2RSxPQUFPTixLQUFLOztVQUdkLElBQU1RLFVBQVUsR0FBR1AsSUFBSSxDQUFDTSxpQkFBcUM7VUFHN0QsSUFBTUUsZUFBZSxHQUFHekIsT0FBTyxDQUFDLHNEQUFzRCxDQUFDO1VBRXZGLElBQUkwQixLQUFLO1VBQ1QsSUFBSTtZQUNGQSxLQUFLLEdBQUdELGVBQWUsQ0FBQ0QsVUFBVSxDQUFDO1dBQ3BDLENBQUMsT0FBT0csQ0FBQyxFQUFFO1lBRVZELEtB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