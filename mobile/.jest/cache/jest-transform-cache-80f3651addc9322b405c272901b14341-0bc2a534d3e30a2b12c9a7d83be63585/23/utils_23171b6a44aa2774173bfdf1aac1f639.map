{"version":3,"names":["_utils","require","ACTIVE_THREAD_ID_STRING","isValidProfile","profile","samples","length","__DEV__","logger","log","profile_id","findProfiledTransactionsFromEnvelope","envelope","events","forEachEnvelopeItem","item","type","j","event","contexts","push","createProfilingEvent","createProfilePayload","release","environment","event_id","transaction","start_timestamp","Date","now","trace_id","_c","_b","_a","trace","os_platform","_e","_d","os","name","os_version","_g","_f","version","os_build","_j","_h","build","device_locale","_l","_k","device","locale","device_model","_o","_m","model","device_manufacturer","_q","_p","manufacturer","device_architecture","_s","_r","arch","device_is_emulator","_u","_t","simulator","cpuProfile","_ref","timestamp","toISOString","platform","runtime","build_number","architecture","is_emulator","id","active_thread_id","addProfilesToEnvelope","profiles"],"sources":["../../../src/js/profiling/utils.ts"],"sourcesContent":["import type { Envelope, Event, Profile } from '@sentry/types';\nimport { forEachEnvelopeItem, logger } from '@sentry/utils';\n\nimport type { RawThreadCpuProfile } from './types';\n\nconst ACTIVE_THREAD_ID_STRING = '0';\n\n/**\n *\n */\nexport function isValidProfile(profile: RawThreadCpuProfile): profile is RawThreadCpuProfile & { profile_id: string } {\n  if (profile.samples.length <= 1) {\n    if (__DEV__) {\n      // Log a warning if the profile has less than 2 samples so users can know why\n      // they are not seeing any profiling data and we cant avoid the back and forth\n      // of asking them to provide us with a dump of the profile data.\n      logger.log('[Profiling] Discarding profile because it contains less than 2 samples');\n    }\n    return false;\n  }\n\n  if (!profile.profile_id) {\n    return false;\n  }\n\n  return true;\n}\n\n/**\n * Finds transactions with profile_id context in the envelope\n * @param envelope\n * @returns\n */\nexport function findProfiledTransactionsFromEnvelope(envelope: Envelope): Event[] {\n  const events: Event[] = [];\n\n  forEachEnvelopeItem(envelope, (item, type) => {\n    if (type !== 'transaction') {\n      return;\n    }\n\n    // First item is the type\n    for (let j = 1; j < item.length; j++) {\n      const event = item[j];\n\n      // @ts-expect-error accessing private property\n      // eslint-disable-next-line @typescript-eslint/no-unsafe-member-access\n      if (event && event.contexts && event.contexts['profile'] && event.contexts['profile']['profile_id']) {\n        events.push(item[j] as Event);\n      }\n    }\n  });\n\n  return events;\n}\n\n/**\n * Creates a profiling envelope item, if the profile does not pass validation, returns null.\n * @param event\n * @returns {Profile | null}\n */\nexport function createProfilingEvent(profile: RawThreadCpuProfile, event: Event): Profile | null {\n  if (!isValidProfile(profile)) {\n    return null;\n  }\n\n  return createProfilePayload(profile, {\n    release: event.release || '',\n    environment: event.environment || '',\n    event_id: event.event_id || '',\n    transaction: event.transaction || '',\n    start_timestamp: event.start_timestamp ? event.start_timestamp * 1000 : Date.now(),\n    trace_id: (event?.contexts?.trace?.trace_id as string) ?? '',\n    // eslint-disable-next-line @typescript-eslint/no-unsafe-member-access\n    profile_id: profile.profile_id,\n    os_platform: event.contexts?.os?.name || '',\n    os_version: event.contexts?.os?.version || '',\n    os_build: event.contexts?.os?.build || '',\n    device_locale: (event.contexts?.device?.locale as string) || '',\n    device_model: event.contexts?.device?.model || '',\n    device_manufacturer: event.contexts?.device?.manufacturer || '',\n    device_architecture: event.contexts?.device?.arch || '',\n    device_is_emulator: event.contexts?.device?.simulator || false,\n  });\n}\n\n/**\n * Create a profile\n * @param profile\n * @param options\n * @returns\n */\nfunction createProfilePayload(\n  cpuProfile: RawThreadCpuProfile,\n  {\n    release,\n    environment,\n    event_id,\n    transaction,\n    start_timestamp,\n    trace_id,\n    profile_id,\n    os_platform,\n    os_version,\n    os_build,\n    device_locale,\n    device_model,\n    device_manufacturer,\n    device_architecture,\n    device_is_emulator,\n  }: {\n    release: string;\n    environment: string;\n    event_id: string;\n    transaction: string;\n    start_timestamp: number;\n    trace_id: string | undefined;\n    profile_id: string;\n    os_platform: string;\n    os_version: string;\n    os_build?: string;\n    device_locale: string;\n    device_model: string;\n    device_manufacturer: string;\n    device_architecture: string;\n    device_is_emulator: boolean;\n  },\n): Profile {\n  // Log a warning if the profile has an invalid traceId (should be uuidv4).\n  // All profiles and transactions are rejected if this is the case and we want to\n  // warn users that this is happening if they enable debug flag\n  if (trace_id && trace_id.length !== 32) {\n    if (__DEV__) {\n      logger.log(`[Profiling] Invalid traceId: ${trace_id} on profiled event`);\n    }\n  }\n\n  const profile: Profile = {\n    event_id: profile_id,\n    timestamp: new Date(start_timestamp).toISOString(),\n    platform: 'node',\n    version: '1',\n    release: release,\n    environment: environment,\n    runtime: {\n      name: 'hermes',\n      version: '', // TODO: get hermes version\n    },\n    os: {\n      name: os_platform,\n      version: os_version,\n      build_number: os_build,\n    },\n    device: {\n      locale: device_locale,\n      model: device_model,\n      manufacturer: device_manufacturer,\n      architecture: device_architecture,\n      is_emulator: device_is_emulator,\n    },\n    profile: cpuProfile,\n    transaction: {\n      name: transaction,\n      id: event_id,\n      trace_id: trace_id || '',\n      active_thread_id: ACTIVE_THREAD_ID_STRING,\n    },\n  };\n\n  return profile;\n}\n\n/**\n * Adds items to envelope if they are not already present - mutates the envelope.\n * @param envelope\n */\nexport function addProfilesToEnvelope(envelope: Envelope, profiles: Profile[]): Envelope {\n  if (!profiles.length) {\n    return envelope;\n  }\n\n  for (const profile of profiles) {\n    // @ts-expect-error untyped envelope\n    envelope[1].push([{ type: 'profile' }, profile]);\n  }\n  return envelope;\n}\n"],"mappings":"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"}