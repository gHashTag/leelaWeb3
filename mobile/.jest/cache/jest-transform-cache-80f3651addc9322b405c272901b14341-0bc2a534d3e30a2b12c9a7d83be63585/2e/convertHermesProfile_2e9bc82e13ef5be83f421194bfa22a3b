14c4850f1ee27ea5df292cbce5034d2e
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.convertToSentryProfile = convertToSentryProfile;
exports.mapSamples = mapSamples;
var _utils = require("@sentry/utils");
var _reactNative = require("react-native");
var _rewriteframes = require("../integrations/rewriteframes");
var _hermes = require("./hermes");
var _integration = require("./integration");
var MS_TO_NS = 1e6;
var MAX_PROFILE_DURATION_NS = _integration.MAX_PROFILE_DURATION_MS * MS_TO_NS;
var ANONYMOUS_FUNCTION_NAME = 'anonymous';
var UNKNOWN_STACK_ID = -1;
var JS_THREAD_NAME = 'JavaScriptThread';
var JS_THREAD_PRIORITY = 1;
var DEFAULT_BUNDLE_NAME = _reactNative.Platform.OS === 'android' ? _rewriteframes.ANDROID_DEFAULT_BUNDLE_NAME : _reactNative.Platform.OS === 'ios' ? _rewriteframes.IOS_DEFAULT_BUNDLE_NAME : undefined;
function convertToSentryProfile(hermesProfile) {
  if (hermesProfile.samples.length === 0) {
    _utils.logger.warn('[Profiling] No samples found in profile.');
    return null;
  }
  var _mapSamples = mapSamples(hermesProfile.samples),
    samples = _mapSamples.samples,
    hermesStacks = _mapSamples.hermesStacks,
    jsThreads = _mapSamples.jsThreads;
  var _mapFrames = mapFrames(hermesProfile.stackFrames),
    frames = _mapFrames.frames,
    hermesStackFrameIdToSentryFrameIdMap = _mapFrames.hermesStackFrameIdToSentryFrameIdMap;
  var _mapStacks = mapStacks(hermesStacks, hermesProfile.stackFrames, hermesStackFrameIdToSentryFrameIdMap),
    stacks = _mapStacks.stacks,
    hermesStackToSentryStackMap = _mapStacks.hermesStackToSentryStackMap;
  for (var sample of samples) {
    var sentryStackId = hermesStackToSentryStackMap.get(sample.stack_id);
    if (sentryStackId === undefined) {
      _utils.logger.error(`[Profiling] Hermes Stack ID ${sample.stack_id} not found when mapping to Sentry Stack ID.`);
      sample.stack_id = UNKNOWN_STACK_ID;
    } else {
      sample.stack_id = sentryStackId;
    }
  }
  var thread_metadata = {};
  for (var jsThreadId of jsThreads) {
    thread_metadata[jsThreadId] = {
      name: JS_THREAD_NAME,
      priority: JS_THREAD_PRIORITY
    };
  }
  return {
    samples: samples,
    frames: frames,
    stacks: stacks,
    thread_metadata: thread_metadata
  };
}
function mapSamples(hermesSamples) {
  var maxElapsedSinceStartNs = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : MAX_PROFILE_DURATION_NS;
  var jsThreads = new Set();
  var hermesStacks = new Set();
  var start = Number(hermesSamples[0].ts);
  var samples = [];
  for (var hermesSample of hermesSamples) {
    jsThreads.add(hermesSample.tid);
    hermesStacks.add(hermesSample.sf);
    var elapsed_since_start_ns = (Number(hermesSample.ts) - start) * 1e3;
    if (elapsed_since_start_ns >= maxElapsedSinceStartNs) {
      _utils.logger.warn(`[Profiling] Sample has elapsed time since start ${elapsed_since_start_ns}ns ` + `greater than the max elapsed time ${maxElapsedSinceStartNs}ns.`);
      break;
    }
    samples.push({
      stack_id: hermesSample.sf,
      thread_id: hermesSample.tid,
      elapsed_since_start_ns: elapsed_since_start_ns.toFixed(0)
    });
  }
  return {
    samples: samples,
    hermesStacks: hermesStacks,
    jsThreads: jsThreads
  };
}
function mapFrames(hermesStackFrames) {
  var frames = [];
  var hermesStackFrameIdToSentryFrameIdMap = new Map();
  for (var key in hermesStackFrames) {
    if (!Object.prototype.hasOwnProperty.call(hermesStackFrames, key)) {
      continue;
    }
    hermesStackFrameIdToSentryFrameIdMap.set(Number(key), frames.length);
    var hermesFrame = hermesStackFrames[key];
    var functionName = (0, _hermes.parseHermesStackFrameFunctionName)(hermesFrame.name);
    frames.push({
      function: functionName || ANONYMOUS_FUNCTION_NAME,
      file: hermesFrame.category == 'JavaScript' ? DEFAULT_BUNDLE_NAME : undefined,
      lineno: hermesFrame.line !== undefined ? Number(hermesFrame.line) : undefined,
      colno: hermesFrame.column !== undefined ? Number(hermesFrame.column) : undefined
    });
  }
  return {
    frames: frames,
    hermesStackFrameIdToSentryFrameIdMap: hermesStackFrameIdToSentryFrameIdMap
  };
}
function mapStacks(hermesStacks, hermesStackFrames, hermesStackFrameIdToSentryFrameIdMap) {
  var hermesStackToSentryStackMap = new Map();
  var stacks = [];
  for (var hermesStackFunctionFrameId of hermesStacks) {
    var stackId = stacks.length;
    hermesStackToSentryStackMap.set(hermesStackFunctionFrameId, stackId);
    var stack = [];
    var currentHermesFrameId = hermesStackFunctionFrameId;
    while (currentHermesFrameId !== undefined) {
      var sentryFrameId = hermesStackFrameIdToSentryFrameIdMap.get(currentHermesFrameId);
      sentryFrameId !== undefined && stack.push(sentryFrameId);
      currentHermesFrameId = hermesStackFrames[currentHermesFrameId] && hermesStackFrames[currentHermesFrameId].parent;
    }
    stacks.push(stack);
  }
  return {
    stacks: stacks,
    hermesStackToSentryStackMap: hermesStackToSentryStackMap
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfdXRpbHMiLCJyZXF1aXJlIiwiX3JlYWN0TmF0aXZlIiwiX3Jld3JpdGVmcmFtZXMiLCJfaGVybWVzIiwiX2ludGVncmF0aW9uIiwiTVNfVE9fTlMiLCJNQVhfUFJPRklMRV9EVVJBVElPTl9OUyIsIk1BWF9QUk9GSUxFX0RVUkFUSU9OX01TIiwiQU5PTllNT1VTX0ZVTkNUSU9OX05BTUUiLCJVTktOT1dOX1NUQUNLX0lEIiwiSlNfVEhSRUFEX05BTUUiLCJKU19USFJFQURfUFJJT1JJVFkiLCJERUZBVUxUX0JVTkRMRV9OQU1FIiwiUGxhdGZvcm0iLCJPUyIsIkFORFJPSURfREVGQVVMVF9CVU5ETEVfTkFNRSIsIklPU19ERUZBVUxUX0JVTkRMRV9OQU1FIiwidW5kZWZpbmVkIiwiY29udmVydFRvU2VudHJ5UHJvZmlsZSIsImhlcm1lc1Byb2ZpbGUiLCJzYW1wbGVzIiwibGVuZ3RoIiwibG9nZ2VyIiwid2FybiIsIl9tYXBTYW1wbGVzIiwibWFwU2FtcGxlcyIsImhlcm1lc1N0YWNrcyIsImpzVGhyZWFkcyIsIl9tYXBGcmFtZXMiLCJtYXBGcmFtZXMiLCJzdGFja0ZyYW1lcyIsImZyYW1lcyIsImhlcm1lc1N0YWNrRnJhbWVJZFRvU2VudHJ5RnJhbWVJZE1hcCIsIl9tYXBTdGFja3MiLCJtYXBTdGFja3MiLCJzdGFja3MiLCJoZXJtZXNTdGFja1RvU2VudHJ5U3RhY2tNYXAiLCJzYW1wbGUiLCJzZW50cnlTdGFja0lkIiwiZ2V0Iiwic3RhY2tfaWQiLCJlcnJvciIsInRocmVhZF9tZXRhZGF0YSIsImpzVGhyZWFkSWQiLCJuYW1lIiwicHJpb3JpdHkiLCJoZXJtZXNTYW1wbGVzIiwibWF4RWxhcHNlZFNpbmNlU3RhcnROcyIsImFyZ3VtZW50cyIsIlNldCIsInN0YXJ0IiwiTnVtYmVyIiwidHMiLCJoZXJtZXNTYW1wbGUiLCJhZGQiLCJ0aWQiLCJzZiIsImVsYXBzZWRfc2luY2Vfc3RhcnRfbnMiLCJwdXNoIiwidGhyZWFkX2lkIiwidG9GaXhlZCIsImhlcm1lc1N0YWNrRnJhbWVzIiwiTWFwIiwia2V5IiwiT2JqZWN0IiwicHJvdG90eXBlIiwiaGFzT3duUHJvcGVydHkiLCJjYWxsIiwic2V0IiwiaGVybWVzRnJhbWUiLCJmdW5jdGlvbk5hbWUiLCJwYXJzZUhlcm1lc1N0YWNrRnJhbWVGdW5jdGlvbk5hbWUiLCJmdW5jdGlvbiIsImZpbGUiLCJjYXRlZ29yeSIsImxpbmVubyIsImxpbmUiLCJjb2xubyIsImNvbHVtbiIsImhlcm1lc1N0YWNrRnVuY3Rpb25GcmFtZUlkIiwic3RhY2tJZCIsInN0YWNrIiwiY3VycmVudEhlcm1lc0ZyYW1lSWQiLCJzZW50cnlGcmFtZUlkIiwicGFyZW50Il0sInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2pzL3Byb2ZpbGluZy9jb252ZXJ0SGVybWVzUHJvZmlsZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdHlwZSB7IEZyYW1lSWQsIFN0YWNrSWQsIFRocmVhZENwdUZyYW1lLCBUaHJlYWRDcHVTYW1wbGUsIFRocmVhZENwdVN0YWNrLCBUaHJlYWRJZCB9IGZyb20gJ0BzZW50cnkvdHlwZXMnO1xuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSAnQHNlbnRyeS91dGlscyc7XG5pbXBvcnQgeyBQbGF0Zm9ybSB9IGZyb20gJ3JlYWN0LW5hdGl2ZSc7XG5cbmltcG9ydCB7IEFORFJPSURfREVGQVVMVF9CVU5ETEVfTkFNRSwgSU9TX0RFRkFVTFRfQlVORExFX05BTUUgfSBmcm9tICcuLi9pbnRlZ3JhdGlvbnMvcmV3cml0ZWZyYW1lcyc7XG5pbXBvcnQgdHlwZSAqIGFzIEhlcm1lcyBmcm9tICcuL2hlcm1lcyc7XG5pbXBvcnQgeyBwYXJzZUhlcm1lc1N0YWNrRnJhbWVGdW5jdGlvbk5hbWUgfSBmcm9tICcuL2hlcm1lcyc7XG5pbXBvcnQgeyBNQVhfUFJPRklMRV9EVVJBVElPTl9NUyB9IGZyb20gJy4vaW50ZWdyYXRpb24nO1xuaW1wb3J0IHR5cGUgeyBSYXdUaHJlYWRDcHVQcm9maWxlIH0gZnJvbSAnLi90eXBlcyc7XG5cbmNvbnN0IE1TX1RPX05TID0gMWU2O1xuY29uc3QgTUFYX1BST0ZJTEVfRFVSQVRJT05fTlMgPSBNQVhfUFJPRklMRV9EVVJBVElPTl9NUyAqIE1TX1RPX05TO1xuY29uc3QgQU5PTllNT1VTX0ZVTkNUSU9OX05BTUUgPSAnYW5vbnltb3VzJztcbmNvbnN0IFVOS05PV05fU1RBQ0tfSUQgPSAtMTtcbmNvbnN0IEpTX1RIUkVBRF9OQU1FID0gJ0phdmFTY3JpcHRUaHJlYWQnO1xuY29uc3QgSlNfVEhSRUFEX1BSSU9SSVRZID0gMTtcbmNvbnN0IERFRkFVTFRfQlVORExFX05BTUUgPVxuICBQbGF0Zm9ybS5PUyA9PT0gJ2FuZHJvaWQnID8gQU5EUk9JRF9ERUZBVUxUX0JVTkRMRV9OQU1FIDogUGxhdGZvcm0uT1MgPT09ICdpb3MnID8gSU9TX0RFRkFVTFRfQlVORExFX05BTUUgOiB1bmRlZmluZWQ7XG5cbi8qKlxuICogQ29udmVydHMgYSBIZXJtZXMgcHJvZmlsZSB0byBhIFNlbnRyeSBwcm9maWxlLlxuICpcbiAqIE1hcHMgSGVybWVzIHNhbXBsZXMgdG8gU2VudHJ5IHNhbXBsZXMuXG4gKiBNYXBzIEhlcm1lcyBzdGFjayBmcmFtZXMgdG8gU2VudHJ5IGZyYW1lcy5cbiAqIEhlcm1lcyBzdGFjayBmcmFtZSBpcyBhbiBvYmplY3QgcmVwcmVzZW50aW5nIGEgZnVuY3Rpb24gY2FsbCBpbiB0aGUgc3RhY2tcbiAqIHdpdGggYSBsaW5rIHRvIGl0cyBwYXJlbnQgc3RhY2sgZnJhbWUuIFJvb3Qgb2YgdGhlIHJlcHJlc2VudGVkIHN0YWNrIHRyZWVcbiAqIGlzIG1haW4gZnVuY3Rpb24gY2FsbCBpbiBIZXJtZXMgdGhhdCBpcyBbcm9vdF0gc3RhY2sgZnJhbWUuXG4gKlxuICogQHJldHVybnMgU2VudHJ5IHByb2ZpbGUgb3IgbnVsbCBpZiBubyBzYW1wbGVzIGFyZSBmb3VuZC5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGNvbnZlcnRUb1NlbnRyeVByb2ZpbGUoaGVybWVzUHJvZmlsZTogSGVybWVzLlByb2ZpbGUpOiBSYXdUaHJlYWRDcHVQcm9maWxlIHwgbnVsbCB7XG4gIGlmIChoZXJtZXNQcm9maWxlLnNhbXBsZXMubGVuZ3RoID09PSAwKSB7XG4gICAgbG9nZ2VyLndhcm4oJ1tQcm9maWxpbmddIE5vIHNhbXBsZXMgZm91bmQgaW4gcHJvZmlsZS4nKTtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIGNvbnN0IHsgc2FtcGxlcywgaGVybWVzU3RhY2tzLCBqc1RocmVhZHMgfSA9IG1hcFNhbXBsZXMoaGVybWVzUHJvZmlsZS5zYW1wbGVzKTtcblxuICBjb25zdCB7IGZyYW1lcywgaGVybWVzU3RhY2tGcmFtZUlkVG9TZW50cnlGcmFtZUlkTWFwIH0gPSBtYXBGcmFtZXMoaGVybWVzUHJvZmlsZS5zdGFja0ZyYW1lcyk7XG5cbiAgY29uc3QgeyBzdGFja3MsIGhlcm1lc1N0YWNrVG9TZW50cnlTdGFja01hcCB9ID0gbWFwU3RhY2tzKFxuICAgIGhlcm1lc1N0YWNrcyxcbiAgICBoZXJtZXNQcm9maWxlLnN0YWNrRnJhbWVzLFxuICAgIGhlcm1lc1N0YWNrRnJhbWVJZFRvU2VudHJ5RnJhbWVJZE1hcCxcbiAgKTtcblxuICBmb3IgKGNvbnN0IHNhbXBsZSBvZiBzYW1wbGVzKSB7XG4gICAgY29uc3Qgc2VudHJ5U3RhY2tJZCA9IGhlcm1lc1N0YWNrVG9TZW50cnlTdGFja01hcC5nZXQoc2FtcGxlLnN0YWNrX2lkKTtcbiAgICBpZiAoc2VudHJ5U3RhY2tJZCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoYFtQcm9maWxpbmddIEhlcm1lcyBTdGFjayBJRCAke3NhbXBsZS5zdGFja19pZH0gbm90IGZvdW5kIHdoZW4gbWFwcGluZyB0byBTZW50cnkgU3RhY2sgSUQuYCk7XG4gICAgICBzYW1wbGUuc3RhY2tfaWQgPSBVTktOT1dOX1NUQUNLX0lEO1xuICAgIH0gZWxzZSB7XG4gICAgICBzYW1wbGUuc3RhY2tfaWQgPSBzZW50cnlTdGFja0lkO1xuICAgIH1cbiAgfVxuXG4gIGNvbnN0IHRocmVhZF9tZXRhZGF0YTogUmVjb3JkPFRocmVhZElkLCB7IG5hbWU/OiBzdHJpbmc7IHByaW9yaXR5PzogbnVtYmVyIH0+ID0ge307XG4gIGZvciAoY29uc3QganNUaHJlYWRJZCBvZiBqc1RocmVhZHMpIHtcbiAgICB0aHJlYWRfbWV0YWRhdGFbanNUaHJlYWRJZF0gPSB7XG4gICAgICBuYW1lOiBKU19USFJFQURfTkFNRSxcbiAgICAgIHByaW9yaXR5OiBKU19USFJFQURfUFJJT1JJVFksXG4gICAgfTtcbiAgfVxuXG4gIHJldHVybiB7XG4gICAgc2FtcGxlcyxcbiAgICBmcmFtZXMsXG4gICAgc3RhY2tzLFxuICAgIHRocmVhZF9tZXRhZGF0YSxcbiAgfTtcbn1cblxuLyoqXG4gKiBNYXBzIEhlcm1lcyBzYW1wbGVzIHRvIFNlbnRyeSBzYW1wbGVzLlxuICogQ2FsY3VsYXRlcyB0aGUgZWxhcHNlZCB0aW1lIHNpbmNlIHRoZSBmaXJzdCBzYW1wbGUgYmFzZWQgb24gdGhlIGFic29sdXRlIHRpbWVzdGFtcHMgb2YgdGhlIEhlcm1lcyBzYW1wbGVzLlxuICogSGVybWVzIHN0YWNrIGZyYW1lIElEcyByZXByZXNlbnQgdGhlIGxhc3QgKGxlYWYsIGZ1cnRoZXN0IGZyb20gdGhlIG1haW4gZnVuYykgZnJhbWUgb2YgdGhlIGNhbGwgc3RhY2suXG4gKiBAcmV0dXJucyB0aGUgbWFwcGVkIFNlbnRyeSBzYW1wbGVzLCB0aGUgc2V0IG9mIEhlcm1lcyBzdGFjayBmcmFtZSBJRHMsIGFuZCB0aGUgc2V0IG9mIEpTIHRocmVhZCBJRHNcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIG1hcFNhbXBsZXMoXG4gIGhlcm1lc1NhbXBsZXM6IEhlcm1lcy5TYW1wbGVbXSxcbiAgbWF4RWxhcHNlZFNpbmNlU3RhcnROczogbnVtYmVyID0gTUFYX1BST0ZJTEVfRFVSQVRJT05fTlMsXG4pOiB7XG4gIHNhbXBsZXM6IFRocmVhZENwdVNhbXBsZVtdO1xuICBoZXJtZXNTdGFja3M6IFNldDxIZXJtZXMuU3RhY2tGcmFtZUlkPjtcbiAganNUaHJlYWRzOiBTZXQ8VGhyZWFkSWQ+O1xufSB7XG4gIGNvbnN0IGpzVGhyZWFkcyA9IG5ldyBTZXQ8VGhyZWFkSWQ+KCk7XG4gIGNvbnN0IGhlcm1lc1N0YWNrcyA9IG5ldyBTZXQ8SGVybWVzLlN0YWNrRnJhbWVJZD4oKTtcblxuICBjb25zdCBzdGFydCA9IE51bWJlcihoZXJtZXNTYW1wbGVzWzBdLnRzKTtcbiAgY29uc3Qgc2FtcGxlczogVGhyZWFkQ3B1U2FtcGxlW10gPSBbXTtcbiAgZm9yIChjb25zdCBoZXJtZXNTYW1wbGUgb2YgaGVybWVzU2FtcGxlcykge1xuICAgIGpzVGhyZWFkcy5hZGQoaGVybWVzU2FtcGxlLnRpZCk7XG4gICAgaGVybWVzU3RhY2tzLmFkZChoZXJtZXNTYW1wbGUuc2YpO1xuXG4gICAgY29uc3QgZWxhcHNlZF9zaW5jZV9zdGFydF9ucyA9IChOdW1iZXIoaGVybWVzU2FtcGxlLnRzKSAtIHN0YXJ0KSAqIDFlMztcbiAgICBpZiAoZWxhcHNlZF9zaW5jZV9zdGFydF9ucyA+PSBtYXhFbGFwc2VkU2luY2VTdGFydE5zKSB7XG4gICAgICBsb2dnZXIud2FybihcbiAgICAgICAgYFtQcm9maWxpbmddIFNhbXBsZSBoYXMgZWxhcHNlZCB0aW1lIHNpbmNlIHN0YXJ0ICR7ZWxhcHNlZF9zaW5jZV9zdGFydF9uc31ucyBgICtcbiAgICAgICAgICBgZ3JlYXRlciB0aGFuIHRoZSBtYXggZWxhcHNlZCB0aW1lICR7bWF4RWxhcHNlZFNpbmNlU3RhcnROc31ucy5gLFxuICAgICAgKTtcbiAgICAgIGJyZWFrO1xuICAgIH1cblxuICAgIHNhbXBsZXMucHVzaCh7XG4gICAgICBzdGFja19pZDogaGVybWVzU2FtcGxlLnNmLFxuICAgICAgdGhyZWFkX2lkOiBoZXJtZXNTYW1wbGUudGlkLFxuICAgICAgZWxhcHNlZF9zaW5jZV9zdGFydF9uczogZWxhcHNlZF9zaW5jZV9zdGFydF9ucy50b0ZpeGVkKDApLFxuICAgIH0pO1xuICB9XG5cbiAgcmV0dXJuIHtcbiAgICBzYW1wbGVzLFxuICAgIGhlcm1lc1N0YWNrcyxcbiAgICBqc1RocmVhZHMsXG4gIH07XG59XG5cbi8qKlxuICogTWFwcyBIZXJtZXMgU3RhY2tGcmFtZXMgdHJlZSByZXByZXNlbnRlZCBhcyBhbiBKUyBvYmplY3QgdG8gYSBTZW50cnkgZnJhbWVzIGFycmF5LlxuICogQ29udmVydHMgbGluZSBhbmQgY29sdW1ucyBzdHJpbmdzIHRvIG51bWJlcnMuXG4gKiBAcmV0dXJucyB0aGUgbWFwcGVkIFNlbnRyeSBmcmFtZXNcbiAqL1xuZnVuY3Rpb24gbWFwRnJhbWVzKGhlcm1lc1N0YWNrRnJhbWVzOiBSZWNvcmQ8SGVybWVzLlN0YWNrRnJhbWVJZCwgSGVybWVzLlN0YWNrRnJhbWU+KToge1xuICBmcmFtZXM6IFRocmVhZENwdUZyYW1lW107XG4gIGhlcm1lc1N0YWNrRnJhbWVJZFRvU2VudHJ5RnJhbWVJZE1hcDogTWFwPEhlcm1lcy5TdGFja0ZyYW1lSWQsIEZyYW1lSWQ+O1xufSB7XG4gIGNvbnN0IGZyYW1lczogVGhyZWFkQ3B1RnJhbWVbXSA9IFtdO1xuICBjb25zdCBoZXJtZXNTdGFja0ZyYW1lSWRUb1NlbnRyeUZyYW1lSWRNYXAgPSBuZXcgTWFwPEhlcm1lcy5TdGFja0ZyYW1lSWQsIEZyYW1lSWQ+KCk7XG4gIGZvciAoY29uc3Qga2V5IGluIGhlcm1lc1N0YWNrRnJhbWVzKSB7XG4gICAgLy8gYXNjIG9yZGVyIGJhc2VkIG9uIHRoZSBrZXkgaXMgbm90IGd1YXJhbnRlZWRcbiAgICBpZiAoIU9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChoZXJtZXNTdGFja0ZyYW1lcywga2V5KSkge1xuICAgICAgY29udGludWU7XG4gICAgfVxuICAgIGhlcm1lc1N0YWNrRnJhbWVJZFRvU2VudHJ5RnJhbWVJZE1hcC5zZXQoTnVtYmVyKGtleSksIGZyYW1lcy5sZW5ndGgpO1xuICAgIGNvbnN0IGhlcm1lc0ZyYW1lID0gaGVybWVzU3RhY2tGcmFtZXNba2V5XTtcblxuICAgIGNvbnN0IGZ1bmN0aW9uTmFtZSA9IHBhcnNlSGVybWVzU3RhY2tGcmFtZUZ1bmN0aW9uTmFtZShoZXJtZXNGcmFtZS5uYW1lKTtcbiAgICBmcmFtZXMucHVzaCh7XG4gICAgICBmdW5jdGlvbjogZnVuY3Rpb25OYW1lIHx8IEFOT05ZTU9VU19GVU5DVElPTl9OQU1FLFxuICAgICAgZmlsZTogaGVybWVzRnJhbWUuY2F0ZWdvcnkgPT0gJ0phdmFTY3JpcHQnID8gREVGQVVMVF9CVU5ETEVfTkFNRSA6IHVuZGVmaW5lZCxcbiAgICAgIGxpbmVubzogaGVybWVzRnJhbWUubGluZSAhPT0gdW5kZWZpbmVkID8gTnVtYmVyKGhlcm1lc0ZyYW1lLmxpbmUpIDogdW5kZWZpbmVkLFxuICAgICAgY29sbm86IGhlcm1lc0ZyYW1lLmNvbHVtbiAhPT0gdW5kZWZpbmVkID8gTnVtYmVyKGhlcm1lc0ZyYW1lLmNvbHVtbikgOiB1bmRlZmluZWQsXG4gICAgfSk7XG4gIH1cblxuICByZXR1cm4ge1xuICAgIGZyYW1lcyxcbiAgICBoZXJtZXNTdGFja0ZyYW1lSWRUb1NlbnRyeUZyYW1lSWRNYXAsXG4gIH07XG59XG5cbi8qKlxuICogTWFwcyBIZXJtZXMgc3RhY2sgZnJhbWUgSURzIHRvIFNlbnRyeSBzdGFjayBhcnJheXMuXG4gKiBIZXJtZXMgc3RhY2sgZnJhbWUgSURzIHJlcHJlc2VudCB0aGUgbGFzdCAobGVhZiwgZnVydGhlc3QgZnJvbSB0aGUgbWFpbiBmdW5jKSBmcmFtZSBvZiB0aGUgY2FsbCBzdGFjay5cbiAqIEByZXR1cm5zIHRoZSBtYXBwZWQgU2VudHJ5IHN0YWNrcyBhbmQgYSBtYXAgZnJvbSBIZXJtZXMgc3RhY2sgSURzIHRvIFNlbnRyeSBzdGFjayBJRHMgKGluZGljZXMgaW4gdGhlIHN0YWNrcyBhcnJheSlcbiAqL1xuZnVuY3Rpb24gbWFwU3RhY2tzKFxuICBoZXJtZXNTdGFja3M6IFNldDxIZXJtZXMuU3RhY2tGcmFtZUlkPixcbiAgaGVybWVzU3RhY2tGcmFtZXM6IFJlY29yZDxIZXJtZXMuU3RhY2tGcmFtZUlkLCBIZXJtZXMuU3RhY2tGcmFtZT4sXG4gIGhlcm1lc1N0YWNrRnJhbWVJZFRvU2VudHJ5RnJhbWVJZE1hcDogTWFwPEhlcm1lcy5TdGFja0ZyYW1lSWQsIEZyYW1lSWQ+LFxuKToge1xuICBzdGFja3M6IFRocmVhZENwdVN0YWNrW107XG4gIGhlcm1lc1N0YWNrVG9TZW50cnlTdGFja01hcDogTWFwPEhlcm1lcy5TdGFja0ZyYW1lSWQsIFN0YWNrSWQ+O1xufSB7XG4gIGNvbnN0IGhlcm1lc1N0YWNrVG9TZW50cnlTdGFja01hcCA9IG5ldyBNYXA8SGVybWVzLlN0YWNrRnJhbWVJZCwgU3RhY2tJZD4oKTtcbiAgY29uc3Qgc3RhY2tzOiBUaHJlYWRDcHVTdGFja1tdID0gW107XG4gIGZvciAoY29uc3QgaGVybWVzU3RhY2tGdW5jdGlvbkZyYW1lSWQgb2YgaGVybWVzU3RhY2tzKSB7XG4gICAgY29uc3Qgc3RhY2tJZCA9IHN0YWNrcy5sZW5ndGg7XG4gICAgaGVybWVzU3RhY2tUb1NlbnRyeVN0YWNrTWFwLnNldChoZXJtZXNTdGFja0Z1bmN0aW9uRnJhbWVJZCwgc3RhY2tJZCk7XG4gICAgY29uc3Qgc3RhY2s6IFRocmVhZENwdVN0YWNrID0gW107XG4gICAgbGV0IGN1cnJlbnRIZXJtZXNGcmFtZUlkOiBIZXJtZXMuU3RhY2tGcmFtZUlkIHwgdW5kZWZpbmVkID0gaGVybWVzU3RhY2tGdW5jdGlvbkZyYW1lSWQ7XG4gICAgd2hpbGUgKGN1cnJlbnRIZXJtZXNGcmFtZUlkICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIGNvbnN0IHNlbnRyeUZyYW1lSWQgPSBoZXJtZXNTdGFja0ZyYW1lSWRUb1NlbnRyeUZyYW1lSWRNYXAuZ2V0KGN1cnJlbnRIZXJtZXNGcmFtZUlkKTtcbiAgICAgIHNlbnRyeUZyYW1lSWQgIT09IHVuZGVmaW5lZCAmJiBzdGFjay5wdXNoKHNlbnRyeUZyYW1lSWQpO1xuICAgICAgY3VycmVudEhlcm1lc0ZyYW1lSWQgPSBoZXJtZXNTdGFja0ZyYW1lc1tjdXJyZW50SGVybWVzRnJhbWVJZF0gJiYgaGVybWVzU3RhY2tGcmFtZXNbY3VycmVudEhlcm1lc0ZyYW1lSWRdLnBhcmVudDtcbiAgICB9XG4gICAgc3RhY2tzLnB1c2goc3RhY2spO1xuICB9XG5cbiAgcmV0dXJuIHtcbiAgICBzdGFja3MsXG4gICAgaGVybWVzU3RhY2tUb1NlbnRyeVN0YWNrTWFwLFxuICB9O1xufVxuIl0sIm1hcHBpbmdzIjoiOzs7OztBQUNBLElBQUFBLE1BQUEsR0FBQUMsT0FBQTtBQUNBLElBQUFDLFlBQUEsR0FBQUQsT0FBQTtBQUVBLElBQUFFLGNBQUEsR0FBQUYsT0FBQTtBQUVBLElBQUFHLE9BQUEsR0FBQUgsT0FBQTtBQUNBLElBQUFJLFlBQUEsR0FBQUosT0FBQTtBQUdBLElBQU1LLFFBQVEsR0FBRyxHQUFHO0FBQ3BCLElBQU1DLHVCQUF1QixHQUFHQyxvQ0FBdUIsR0FBR0YsUUFBUTtBQUNsRSxJQUFNRyx1QkFBdUIsR0FBRyxXQUFXO0FBQzNDLElBQU1DLGdCQUFnQixHQUFHLENBQUMsQ0FBQztBQUMzQixJQUFNQyxjQUFjLEdBQUcsa0JBQWtCO0FBQ3pDLElBQU1DLGtCQUFrQixHQUFHLENBQUM7QUFDNUIsSUFBTUMsbUJBQW1CLEdBQ3ZCQyxxQkFBUSxDQUFDQyxFQUFFLEtBQUssU0FBUyxHQUFHQywwQ0FBMkIsR0FBR0YscUJBQVEsQ0FBQ0MsRUFBRSxLQUFLLEtBQUssR0FBR0Usc0NBQXVCLEdBQUdDLFNBQVM7QUFhakgsU0FBVUMsc0JBQXNCQSxDQUFDQyxhQUE2QjtFQUNsRSxJQUFJQSxhQUFhLENBQUNDLE9BQU8sQ0FBQ0MsTUFBTSxLQUFLLENBQUMsRUFBRTtJQUN0Q0MsYUFBTSxDQUFDQyxJQUFJLENBQUMsMENBQTBDLENBQUM7SUFDdkQsT0FBTyxJQUFJOztFQUdiLElBQUFDLFdBQUEsR0FBNkNDLFVBQVUsQ0FBQ04sYUFBYSxDQUFDQyxPQUFPLENBQUM7SUFBdEVBLE9BQU8sR0FBQUksV0FBQSxDQUFQSixPQUFPO0lBQUVNLFlBQVksR0FBQUYsV0FBQSxD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